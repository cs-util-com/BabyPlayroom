<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baby Tummyâ€‘Time Motivator</title>

  <!-- Tailwind CSS (CDN build) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- OpenMoji color font -->
  <link rel="preload" as="font" href="https://cdn.jsdelivr.net/gh/hfg-gmuend/openmoji@15.0.0/font/OpenMoji-color-colr1_svg/OpenMoji-color-colr1_svg.woff2" type="font/woff2" crossorigin>
  <style>
    @font-face {
      font-family: "OpenMoji";
      src: url("https://cdn.jsdelivr.net/gh/hfg-gmuend/openmoji@15.0.0/font/OpenMoji-color-colr1_svg/OpenMoji-color-colr1_svg.woff2") format("woff2");
      font-weight: normal;
      font-style: normal;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: "OpenMoji", system-ui, sans-serif;
    }

    /* Subtle pastel stripe pattern; colours are swapped at runtime via JS */
    body {
      --bg1: #ffb3ba;
      --bg2: #ffdfba;
      background-image: repeating-linear-gradient(135deg, var(--bg1) 0 8px, var(--bg2) 8px 16px);
      background-size: cover;
    }

    /* Moving animal sprite */
    .animal {
      position: absolute;
      user-select: none;
      touch-action: none;
      cursor: pointer;
      animation: drift var(--cycle, 7s) ease-in-out infinite alternate;
      transform: translate(var(--sx, 0), var(--sy, 0));
    }

    /* Drift keyframe â€“ the element animates between two translate values that JS rewrites every cycle */
    @keyframes drift {
      to {
        transform: translate(var(--dx), var(--dy));
      }
    }

    /* Despawn effects (simplified versions) */
    @keyframes fade_out {
      to {
        opacity: 0;
      }
    }

    @keyframes shrink_fade {
      to {
        transform: scale(0.85);
        opacity: 0;
      }
    }

    @keyframes slide_away {
      to {
        transform: translateX(15%);
        opacity: 0;
      }
    }

    @keyframes wiggle_spin {
      0%,
      100% {
        transform: rotate(0deg);
      }
      50% {
        transform: rotate(60deg);
      }
    }

    @keyframes pulse_glow {
      0% {
        filter: drop-shadow(0 0 0px var(--glow));
      }
      50% {
        filter: drop-shadow(0 0 10px var(--glow));
      }
      100% {
        opacity: 0;
      }
    }
  </style>

  <!-- Howler.js for audio playback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js" integrity="sha512-x/7UQVUMo30k2RK4L8V2w2mekXar3pZHCJbSx7soa39CNAQYmf9hkuEc1jWSE80X7iK50M6YkvmTFRcX/h7Ldg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
  <!-- Main playâ€‘field (empty; animals injected via JS) -->
  <div id="game"></div>

  <!-- Parent icon (topâ€‘right) -->
  <button id="parent-btn" class="fixed top-2 right-2 z-50 w-8 h-8 flex items-center justify-center bg-white/40 rounded text-xl select-none">
    âœ•
  </button>

  <!-- Dim overlay + unlock badge (hidden by default) -->
  <div id="dim" class="fixed inset-0 bg-black/40 hidden z-40"></div>
  <div id="unlock" class="fixed top-2 right-2 hidden z-50 w-12 h-12 bg-white/60 rounded-full flex items-center justify-center text-2xl text-gray-800">
    âœ•
  </div>

  <!-- Settings panel (center overlay) -->
  <div id="settings" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="bg-white/90 backdrop-blur rounded-xl p-6 w-11/12 max-w-md space-y-6">
      <!-- Volume -->
      <div>
        <label class="block font-semibold mb-2">Volume</label>
        <input id="volume-slider" type="range" min="0" max="100" value="70" class="w-full accent-blue-500">
      </div>
      <!-- Session length -->
      <div>
        <label class="block font-semibold mb-2">Session Length</label>
        <div class="flex space-x-2">
          <button data-min="3" class="session-btn px-3 py-2 rounded bg-gray-200">3&nbsp;min</button>
          <button data-min="5" class="session-btn px-3 py-2 rounded bg-gray-200">5&nbsp;min</button>
          <button data-min="10" class="session-btn px-3 py-2 rounded bg-blue-500 text-white">10&nbsp;min</button>
        </div>
      </div>
      <!-- Resume button -->
      <div class="flex justify-center">
        <button id="resume" class="px-4 py-2 bg-green-500 text-white rounded">Resume</button>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    /* --------------------------------------------------
     *  CONFIGURATION & DATA
     * -------------------------------------------------- */
    const EFFECT_IDS = [
      "fade_out",
      "shrink_fade",
      "sparkle_burst", // not fully implemented â€“ falls back to fade
      "confetti_pop",  // not fully implemented â€“ falls back to fade
      "bounce_drop",   // not fully implemented â€“ falls back to fade
      "particle_dissolve", // not fully implemented â€“ falls back to fade
      "pulse_glow",
      "wiggle_spin",
      "slide_away",
      "star_trail"     // not fully implemented â€“ falls back to fade
    ];

    const PASTELS = [
      "#FFB3BA",
      "#FFDFBA",
      "#FFFFBA",
      "#BAFFC9",
      "#BAE1FF",
      "#E3BAFF",
      "#FFD1DC",
      "#C1FFD7",
      "#FBE7C6",
      "#D3C0FF"
    ];

    const animals = [
      { emoji: "ðŸ±", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01011751.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01011754.mp3" },
      { emoji: "ðŸ¶", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01003046.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01003039.mp3" },
      { emoji: "ðŸ‘", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01019012.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01019008.mp3" },
      { emoji: "ðŸ„", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01009165.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01009159.mp3" },
      { emoji: "ðŸ¦", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01021022.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01021031.mp3" },
      { emoji: "ðŸ¤", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01021038.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01021040.mp3" },
      { emoji: "ðŸ¦†", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01014014.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01014018.mp3" },
      { emoji: "ðŸ¸", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01015001.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01015004.mp3" },
      { emoji: "ðŸ°", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01022005.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01022009.mp3" },
      { emoji: "ðŸ§", appear: "https://sound-effects-media.bbcrewind.co.uk/mp3/01017012.mp3", tap: "https://sound-effects-media.bbcrewind.co.uk/mp3/01017016.mp3" }
    ];

    /* --------------------------------------------------
     *  DOM ELEMENT REFERENCES
     * -------------------------------------------------- */
    const game = document.getElementById("game");
    const parentBtn = document.getElementById("parent-btn");
    const dim = document.getElementById("dim");
    const unlock = document.getElementById("unlock");
    const settings = document.getElementById("settings");
    const volumeSlider = document.getElementById("volume-slider");
    const resumeBtn = document.getElementById("resume");
    const sessionBtns = document.querySelectorAll(".session-btn");

    /* --------------------------------------------------
     *  STATE VARIABLES
     * -------------------------------------------------- */
    let sessionMinutes = 10;
    let masterVolume = 0.7;
    let activeAnimals = 0;
    let spawnInterval;
    let sessionTimeout;
    let firstInteraction = false;

    /* --------------------------------------------------
     *  HELPER FUNCTIONS
     * -------------------------------------------------- */
    const rand = (min, max) => Math.random() * (max - min) + min;
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

    function applyRandomBackground() {
      let c1 = pick(PASTELS), c2 = pick(PASTELS);
      while (c2 === c1) c2 = pick(PASTELS);
      document.body.style.setProperty("--bg1", c1);
      document.body.style.setProperty("--bg2", c2);
      // background-image already defined in CSS uses these vars
    }

    applyRandomBackground();

    /* --------------------------------------------------
     *  SPAWN & MOTION
     * -------------------------------------------------- */
    function setNewDestination(el) {
      const dx = rand(-window.innerWidth * 0.2, window.innerWidth * 0.2);
      const dy = rand(-window.innerHeight * 0.2, window.innerHeight * 0.2);
      el.style.setProperty("--dx", `${dx}px`);
      el.style.setProperty("--dy", `${dy}px`);
      // next cycle duration
      el.style.setProperty("--cycle", `${rand(6, 8)}s`);
    }

    function spawnAnimal() {
      if (activeAnimals >= 10) return;
      const data = pick(animals);
      const span = document.createElement("span");
      span.className = "animal";
      span.textContent = data.emoji;

      // size & position
      const size = rand(60, 120);
      span.style.fontSize = `${size}px`;
      span.style.width = `${size}px`;
      span.style.height = `${size}px`;
      span.style.left = `${rand(0, window.innerWidth - size)}px`;
      span.style.top = `${rand(0, window.innerHeight - size)}px`;

      // initial motion vars
      span.style.setProperty("--sx", "0px");
      span.style.setProperty("--sy", "0px");
      setNewDestination(span);

      game.appendChild(span);
      activeAnimals++;

      // Play appear sound
      if (data.appear) new Howl({ src: [data.appear], html5: true, volume: masterVolume * 0.8 }).play();

      // Every drift cycle, update destination (organic walk)
      span.addEventListener("animationiteration", () => setNewDestination(span));

      // Handle tap â†’ despawn
      span.addEventListener("pointerdown", () => handleTap(span, data));
    }

    function handleTap(el, data) {
      // Play tap sound
      if (data.tap) new Howl({ src: [data.tap], html5: true, volume: masterVolume }).play();

      // Pick a despawn effect
      const effect = pick(EFFECT_IDS);
      el.style.animation = `${effect} 0.7s forwards`;

      setTimeout(() => {
        el.remove();
        activeAnimals--;
      }, 700);
    }

    /* --------------------------------------------------
     *  GAME LOOP & SESSION CONTROL
     * -------------------------------------------------- */
    function startLoop() {
      spawnInterval = setInterval(() => {
        if (activeAnimals < 10) spawnAnimal();
        applyRandomBackground();
      }, 10_000);
    }

    function startSession() {
      if (sessionTimeout) clearTimeout(sessionTimeout);
      startLoop();
      sessionTimeout = setTimeout(() => pauseSession(), sessionMinutes * 60_000);
    }

    function pauseSession() {
      clearInterval(spawnInterval);
      document.querySelectorAll(".animal").forEach((el) => el.remove());
      activeAnimals = 0;
      showSettings();
    }

    /* --------------------------------------------------
     *  PARENT CONTROLS â€“ ICON, UNLOCK SWIPE, SETTINGS
     * -------------------------------------------------- */
    parentBtn.addEventListener("click", () => {
      dim.classList.remove("hidden");
      unlock.classList.remove("hidden");

      let unlocked = false;
      const hit = () => {
        unlocked = true;
        cleanup();
        showSettings();
      };

      function move(e) {
        const rect = unlock.getBoundingClientRect();
        if (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom) {
          hit();
        }
      }

      function cleanup() {
        dim.classList.add("hidden");
        unlock.classList.add("hidden");
        document.removeEventListener("pointermove", move);
      }

      document.addEventListener("pointermove", move);
      setTimeout(() => {
        if (!unlocked) cleanup();
      }, 3000);
    });

    function showSettings() {
      settings.classList.remove("hidden");
    }

    /* Volume slider â†’ Howler volume */
    volumeSlider.addEventListener("input", (e) => {
      masterVolume = e.target.value / 100;
      Howler.volume(masterVolume);
    });

    /* Session length buttons */
    sessionBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        sessionBtns.forEach((b) => b.classList.remove("bg-blue-500", "text-white"));
        btn.classList.add("bg-blue-500", "text-white");
        sessionMinutes = parseInt(btn.dataset.min, 10);
      });
    });

    /* Resume */
    resumeBtn.addEventListener("click", () => {
      settings.classList.add("hidden");
      startSession();
    });

    /* --------------------------------------------------
     *  FIRSTâ€‘RUN INITIALISATION
     * -------------------------------------------------- */
    Howler.volume(masterVolume);

    // Spawn a few animals immediately
    for (let i = 0; i < 5; i++) spawnAnimal();
    startSession();

    // Enter fullscreen + lock to landscape on first interaction
    function requestFS() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().then(() => {
          if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock("landscape").catch(() => { /* ignore */ });
          }
        }).catch(() => { /* ignore */ });
      }
    }

    window.addEventListener("pointerdown", () => {
      if (!firstInteraction) {
        firstInteraction = true;
        requestFS();
      }
    }, { once: true });

    /* --------------------------------------------------
     *  LIGHT PWA â€“ INLINE SERVICE WORKER
     * -------------------------------------------------- */
    if ("serviceWorker" in navigator) {
      const swCode = `
        const CACHE = 'baby-motivator-v1';
        const CORE = self.location.pathname === '/' ? ['./'] : ['.'];
        self.addEventListener('install', e => {
          e.waitUntil(caches.open(CACHE).then(c => c.addAll(CORE)));
        });
        self.addEventListener('fetch', e => {
          e.respondWith(
            caches.match(e.request).then(r => r || fetch(e.request).then(res => {
              if (e.request.url.endsWith('.mp3')) {
                const clone = res.clone();
                caches.open(CACHE).then(c => c.put(e.request, clone));
              }
              return res;
            }))
          );
        });
      `;
      navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], { type: 'text/javascript' })));
    }
  </script>
</body>
</html>
